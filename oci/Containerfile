ARG VERSION="${VERSION:-39}"
ARG VARIANT="${VARIANT:-silverblue}"
# Fedora 39 is the first to officially ship as an OCI image; before then the
# unofficial images could be found at "quay.io/fedora-ostree-desktops/${VARIANT}".
# At some point, they should start hosting images on "registry.fedoraproject.org/fedora/fedora-${VARIANT}".
ARG IMAGE="${IMAGE:-quay.io/fedora/fedora-${VARIANT}}"

# ======================= RUST ======================= #
# Rust is needed to build binaries for both Gnome and  #
# Hyprland environments.                               #
# ==================================================== #
FROM "fedora:${VERSION}" AS rust
RUN dnf install --assumeyes \
        cmake \
        curl \
        gcc \
        g++ \
        git \
 && curl --proto "=https" --tlsv1.2 -sSf "https://sh.rustup.rs" >"/tmp/rustup.sh" \
 && sh /tmp/rustup.sh -qy

# === RUST === #
FROM rust AS alacritty
RUN dnf install --assumeyes fontconfig-devel
# There's absolutely no way I'm settling for Gnome Terminal as my default console.
RUN source "${HOME}/.cargo/env" \
 && git clone "https://github.com/alacritty/alacritty.git" --branch "v0.12.3" "/tmp/alacritty" \
 && (cd "/tmp/alacritty"; cargo build --release --features "wayland") \
 && mkdir -p "/opt/alacritty/bin" "/opt/alacritty/etc/bash_completion.d" "/opt/alacritty/share/pixmaps" "/opt/alacritty/share/applications" \
 && cp "/tmp/alacritty/target/release/alacritty" "/opt/alacritty/bin/alacritty" \
 && cp "/tmp/alacritty/extra/logo/alacritty-term.svg" "/opt/alacritty/share/pixmaps/Alacritty.svg" \
 && cp "/tmp/alacritty/extra/linux/Alacritty.desktop" "/opt/alacritty/share/applications/alacritty.desktop" \
 && cp "/tmp/alacritty/extra/completions/alacritty.bash" "/opt/alacritty/etc/bash_completion.d/alacritty" \
 && rm -rf "/tmp/alacritty"

# ================ #
#                  #
#       GNOME      #
#                  #
# ================ #
FROM "${IMAGE}:${VERSION}" AS gnome
MAINTAINER "Zan Baldwin"
COPY "./usr/" "/usr/"
## Okay, so it turns out that the Flathub version of Firefox works fine with both
## the system-wide trust store, and media codecs. BUT ONLY WHEN THE SYSTEM
## FIREFOX PACKAGE IS INSTALLED. The system RPM package of Firefox is the only
## one to correctly detect system trust stores and have the correct media
## codecs, independently.
#RUN rpm-ostree override remove firefox firefox-langpacks
RUN rpm-ostree install --idempotent --allow-inactive --releasever="${VERSION}" \
        bridge-utils edk2-ovmf guestfs-tools libvirt qemu-kvm virt-install virt-manager \
        podman-docker podman-plugins podman-tui containernetworking-plugins aardvark-dns \
        distrobox ffmpeg-free fzf make ncdu nss-tools neovim tlp tlp-rdw \
 && systemctl enable "libvirtd" \
 && systemctl enable "podman.service" \
 && systemctl enable "podman.socket" \
 && systemctl enable "podman-restart.service" \
 && systemctl enable "flatpak-update.service" \
 && (systemctl enable "tlp.service" || true) \
 && cat "/etc/sudoers" | grep -v "secure_path" | tee "/etc/sudoers" >"/dev/null" \
 && rm -rf /tmp/* /var/* \
 && ostree container commit
COPY --from="alacritty" "/opt/alacritty/" "/usr/"

# === RUST === #
FROM rust AS rust-build
RUN source "${HOME}/.cargo/env" \
 && git clone "https://github.com/Horus645/swww.git" --branch "v0.8.1" "/tmp/swww" \
 && (cd "/tmp/swww"; cargo build --release) \
 && mkdir -p "/opt/swww/bin" "/opt/swww/etc/bash_completion.d" \
 && cp "/tmp/swww/target/release/swww" "/opt/swww/bin/swww" \
 && cp "/tmp/swww/target/release/swww-daemon" "/opt/swww/bin/swww-daemon" \
 && cp "/tmp/swww/completions/swww.bash" "/opt/swww/etc/bash_completion.d/swww" \
 && rm -rf "/tmp/swww"

# === GOLANG === #
FROM "fedora:${VERSION}" as golang-build
RUN dnf install --assumeyes \
        git \
        golang
RUN git clone "https://github.com/nwg-piotr/nwg-drawer.git" --branch "v0.4.3" "/tmp/nwg-drawer" \
 && dnf install --assumeyes \
        cairo-gobject-devel \
        glib2-devel \
        gtk-layer-shell-devel \
        gtk3-devel \
        make \
 && make -C "/tmp/nwg-drawer" get \
 && make -C "/tmp/nwg-drawer" build \
 && mkdir -p "/opt/nwg-drawer/share/nwg-drawer" "/opt/nwg-drawer/bin" \
 && cp -r "/tmp/nwg-drawer/desktop-directories" "/opt/nwg-drawer/share/nwg-drawer/" \
 && cp "/tmp/nwg-drawer/drawer.css" "/opt/nwg-drawer/share/nwg-drawer/" \
 && cp "/tmp/nwg-drawer/bin/nwg-drawer" "/opt/nwg-drawer/bin/" \
 && rm -rf "/tmp/nwg-drawer"

# ================ #
#                  #
#     Hyprland     #
#                  #
# ================ #
FROM gnome AS hyprland
MAINTAINER "Zan Baldwin"
# The Hyprland package in the Fedora repositories only seems to be a version or
# two behind. Just install that instead of trying to compile from source - there's
# too many dev/runtime dependencies, and sometimes xdg-desktop-portal-hyprland
# just fails to build. It's not worth the hassle.
RUN rpm-ostree install --idempotent --allow-inactive \
        hyprland \
        waybar \
 && rm -rf /tmp/* /var/* \
 && ostree container commit
# Tools built in previous steps.
COPY --from="rust-build" "/opt/swww/" "/usr/"
COPY --from="golang-build" "/opt/nwg-drawer/" "/usr/"
